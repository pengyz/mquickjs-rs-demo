// Glue implementations for RIDL classes

{%- for class in classes %}

#[repr(C)]
struct {{ module_name|capitalize }}{{ class.name|capitalize }}Opaque {
    v: Box<dyn crate::generated::api::{{ class.name|capitalize }}Class>,
}

#[unsafe(no_mangle)]
pub unsafe extern "C" fn js_{{ module_name|lower }}_{{ class.name|lower }}_constructor(
    ctx: *mut mquickjs_rs::mquickjs_ffi::JSContext,
    this_val: mquickjs_rs::mquickjs_ffi::JSValue,
    argc: c_int,
    argv: *mut mquickjs_rs::mquickjs_ffi::JSValue,
) -> mquickjs_rs::mquickjs_ffi::JSValue {
    let _ = argc;
    let _ = argv;

    // Create JS object of the RIDL class.
    let obj = unsafe { mquickjs_rs::mquickjs_ffi::JS_NewObjectClassUser(ctx, mquickjs_rs::mquickjs_ffi::RIDL_CLASS_{{ module_name }}_{{ class.name }}) };
    if (obj as u32) & ((1u32 << (mquickjs_rs::mquickjs_ffi::JS_TAG_SPECIAL_BITS as u32)) - 1)
        == (mquickjs_rs::mquickjs_ffi::JS_TAG_EXCEPTION as u32)
    {
        return obj;
    }

    // Call crate-local allocator hook.
    let inst: Box<dyn crate::generated::api::{{ class.name|capitalize }}Class> = crate::impls::new_{{ class.name|lower }}(ctx, this_val, core::slice::from_raw_parts(argv, argc as usize).to_vec());
    let opaque = Box::new({{ module_name|capitalize }}{{ class.name|capitalize }}Opaque { v: inst });
    let opaque_ptr = Box::into_raw(opaque);

    unsafe {
        mquickjs_rs::mquickjs_ffi::JS_SetOpaque(ctx, obj, opaque_ptr as *mut core::ffi::c_void);
    }

    obj
}

#[unsafe(no_mangle)]
pub unsafe extern "C" fn js_{{ module_name|lower }}_{{ class.name|lower }}_finalizer(
    ctx: *mut mquickjs_rs::mquickjs_ffi::JSContext,
    val: mquickjs_rs::mquickjs_ffi::JSValue,
) {
    let _ = ctx;
    let ptr = unsafe { mquickjs_rs::mquickjs_ffi::JS_GetOpaque(ctx, val) } as *mut {{ module_name|capitalize }}{{ class.name|capitalize }}Opaque;
    if !ptr.is_null() {
        unsafe { drop(Box::from_raw(ptr)) };
    }
}

{%- for method in class.methods %}
#[unsafe(no_mangle)]
pub unsafe extern "C" fn js_{{ module_name|lower }}_{{ class.name|lower }}_{{ method.name|lower }}(
    ctx: *mut mquickjs_rs::mquickjs_ffi::JSContext,
    this_val: mquickjs_rs::mquickjs_ffi::JSValue,
    argc: c_int,
    argv: *mut mquickjs_rs::mquickjs_ffi::JSValue,
) -> mquickjs_rs::mquickjs_ffi::JSValue {
    // Validate receiver.
    let cid = unsafe { mquickjs_rs::mquickjs_ffi::JS_GetClassID(ctx, this_val) };
    if cid != mquickjs_rs::mquickjs_ffi::RIDL_CLASS_{{ module_name }}_{{ class.name }} {
        return js_throw_type_error(ctx, "invalid receiver");
    }

    let ptr = unsafe { mquickjs_rs::mquickjs_ffi::JS_GetOpaque(ctx, this_val) } as *mut {{ module_name|capitalize }}{{ class.name|capitalize }}Opaque;
    if ptr.is_null() {
        return js_throw_type_error(ctx, "missing opaque");
    }

    {%- for p in method.params %}
    {{ p|emit_param_extract(loop.index0, loop.index)|safe }}
    {%- endfor %}

    let inst = unsafe { &mut *ptr };
    let result = unsafe { inst.v.{{ method.name|lower }}(ctx, {%- for p in method.params %}{{ p|emit_call_arg }}{%- if !loop.last %}, {% endif %}{%- endfor %}) };
    {{ method.return_type|emit_return_convert("result")|safe }}
}
{%- endfor %}

{%- endfor %}
