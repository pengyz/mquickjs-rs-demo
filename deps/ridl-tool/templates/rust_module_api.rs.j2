// Generated module initializer API for RIDL extensions

/// Ensure QuickJS C-side symbols for this module are registered.
///
/// NOTE: This is *not* the per-context singleton initialization.
pub fn initialize_module() {
    crate::generated::symbols::ensure_symbols();
}

/// Fill per-context RIDL extension slots for this module.
/// Called by the app-level aggregated ridl_context_init.
///
/// This API must not reference any app crate types (e.g. app-owned `CtxExt`).
pub fn ridl_module_context_init(w: &mut dyn mquickjs_rs::ridl_runtime::RidlSlotWriter) {
{% if singletons.len() == 0 %}
    let _ = w;
{% else %}
{% for s in singletons %}
    // {{ s.name }} singleton
    unsafe {
        let holder: Box<*mut (dyn crate::impls::{{ s.trait_name }})> = Box::new(Box::into_raw(crate::impls::{{ s.create_fn_name }}()));
        unsafe fn drop_holder(p: *mut core::ffi::c_void) {
            // p: Box<*mut dyn Trait>
            let holder: Box<*mut (dyn crate::impls::{{ s.trait_name }})> = Box::from_raw(p as *mut _);
            // free the underlying singleton allocation
            drop(Box::from_raw(*holder));
        }
        let _ = w.set_slot({{ s.slot_index }}u32, Box::into_raw(holder) as *mut core::ffi::c_void, drop_holder);
    }
{% endfor %}
{% endif %}
}
