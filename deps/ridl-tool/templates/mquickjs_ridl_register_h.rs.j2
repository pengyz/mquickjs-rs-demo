// Auto-generated C header for RIDL interfaces
#ifndef MJS_RIDL_REGISTER_H
#define MJS_RIDL_REGISTER_H

#include "mquickjs.h"
#include "mquickjs_build.h"


// Function declarations for all RIDL-defined functions
{%- for module in modules %}
{%- for function in module.functions %}
JSValue js_{{ function.name|lower }}(JSContext *ctx, JSValue *this_val, int argc, JSValue *argv);
{%- endfor %}
{%- endfor %}

{%- for module in modules %}
{%- for interface in module.interfaces -%}
{%- for method in interface.methods -%}
JSValue js_{{ interface.name|lower }}_{{ method.name }}(JSContext *ctx, JSValue *this_val, int argc, JSValue *argv);
{%- endfor -%}
{%- endfor %}
{%- endfor %}

// Property definition arrays
{%- for module in modules %}
{%- for interface in module.interfaces -%}
extern const JSCFunctionListEntry js_{{ interface.name|lower }}_defs[];
{%- endfor %}
{%- endfor %}

// Interface object class definition (not user classes)
{%- for module in modules %}
{%- for interface in module.interfaces -%}
extern const JSClassDef js_{{ interface.name|lower }}_class_def;
{%- endfor %}
{%- endfor %}

// RIDL user classes
//
// JS class ids (JS_CLASS_*) must be compile-time constants for mquickjs-build to
// generate the ROM table. Numeric IDs are allocated starting from JS_CLASS_USER.
{%- for module in modules %}
{%- for class in module.classes %}
#define JS_CLASS_{{ class.module_name|normalize_ident|upper }}_{{ class.name|normalize_ident|upper }} (JS_CLASS_USER + {{ loop.index0 }})

void js_{{ class.module_name|normalize_ident|lower }}_class_{{ class.name|normalize_ident|lower }}_class(void);
{%- endfor %}
{%- endfor %}

#ifndef JS_CLASS_COUNT
#define JS_CLASS_COUNT (JS_CLASS_USER + {{ classes|length }})
#endif

{{ class_defs }}

// Module initialization functions
{%- for module in modules %}
{%- for interface in module.interfaces -%}
int js_{{ interface.name|lower }}_init(JSContext *ctx, JSModuleDef *m);
{%- endfor %}
{%- endfor %}

// Singletons
{%- for module in modules %}
{%- for s in module.singletons %}
{%- for method in s.methods %}
JSValue js_{{ s.module_name|normalize_ident|lower }}_singleton_{{ s.name|normalize_ident|lower }}_{{ method.name|lower }}(JSContext *ctx, JSValue *this_val, int argc, JSValue *argv);
{%- endfor %}
{%- for prop in s.properties %}
{%- if prop.modifiers|is_readonly_prop %}
JSValue js_{{ s.module_name|normalize_ident|lower }}_singleton_{{ s.name|normalize_ident|lower }}_get_{{ prop.name|lower }}(JSContext *ctx, JSValue *this_val, int argc, JSValue *argv);
{%- endif %}
{%- endfor %}
{%- endfor %}
{%- endfor %}

// Extension definitions
//
// NOTE: For global singletons (e.g. `console`), registration requires file-scope
// declarations/definitions (props/object defs) *and* global table entries.
// A single macro expanded only inside `js_global_object[]` is insufficient.

// File-scope declarations/definitions for RIDL extensions
#define JS_RIDL_DECLS \
{%- for module in modules %}
{%- for s in module.singletons %}
    static const JSPropDef js_{{ s.module_name|normalize_ident|lower }}_singleton_{{ s.name|normalize_ident|lower }}_props[] = { \
{%- for method in s.methods %}
        JS_CFUNC_DEF("{{ method.name }}", {{ method.params|length }}, js_{{ s.module_name|normalize_ident|lower }}_singleton_{{ s.name|normalize_ident|lower }}_{{ method.name|lower }}), \
{%- endfor %}
{%- for prop in s.properties %}
{%- if prop.modifiers|is_readonly_prop %}
        JS_CGETSET_DEF("{{ prop.name }}", js_{{ s.module_name|normalize_ident|lower }}_singleton_{{ s.name|normalize_ident|lower }}_get_{{ prop.name|lower }}, NULL), \
{%- endif %}
{%- endfor %}
        JS_PROP_END, \
    }; \
    static const JSClassDef js_{{ s.module_name|normalize_ident|lower }}_singleton_{{ s.name|normalize_ident|lower }}_obj = \
        JS_OBJECT_DEF("{{ s.name|capitalize }}", js_{{ s.module_name|normalize_ident|lower }}_singleton_{{ s.name|normalize_ident|lower }}_props); \
{%- endfor %}
{%- endfor %}
    /* empty */

/* Ensure `JS_RIDL_DECLS` can be used as a statement in C code. */
#define JS_RIDL_DECLS_STMT do { } while (0)

// Entries injected into `js_global_object[]`
#define JS_STDLIB_EXTENSIONS_{{ module_name|upper }} \
{%- for module in modules %}
{%- for function in module.functions %}
    JS_CFUNC_DEF("{{ function.name }}", {{ function.params|length }}, js_{{ function.name|lower }}), \
{%- endfor %}
{%- for interface in module.interfaces -%}
{%- for method in interface.methods %}
    JS_CFUNC_DEF("{{ method.name }}", {{ method.params|length }}, js_{{ interface.name|lower }}_{{ method.name|lower }}), \
{%- endfor -%}
{%- endfor %}
/* singletons are registered as global object properties (e.g. globalThis.console) */ \
{%- for s in module.singletons %}
    JS_PROP_CLASS_DEF("{{ s.name }}", &js_{{ s.module_name|normalize_ident|lower }}_singleton_{{ s.name|normalize_ident|lower }}_obj), \
{%- endfor %}
/* user classes are exported on global object (global mode) */ \
{%- for class in module.classes %}
    JS_PROP_CLASS_DEF("{{ class.name }}", &js_{{ class.module_name|normalize_ident|lower }}_class_{{ class.name|normalize_ident|lower }}_class_def), \
{%- endfor %}
{%- endfor %}

#define JS_RIDL_EXTENSIONS \
    JS_STDLIB_EXTENSIONS_{{ module_name|upper }}

#endif // MJS_RIDL_REGISTER_H