// Auto-generated C header for RIDL interfaces
#ifndef MJS_RIDL_REGISTER_H
#define MJS_RIDL_REGISTER_H

#include "mquickjs.h"


// Function declarations for all RIDL-defined functions
{% for function in functions %}
JSValue js_{{ function.name|lower }}(JSContext *ctx, JSValue *this_val, int argc, JSValue *argv);
{% endfor %}

{%- for interface in interfaces -%}
{%- for method in interface.methods -%}
JSValue js_{{ interface.name|lower }}_{{ method.name }}(JSContext *ctx, JSValue *this_val, int argc, JSValue *argv);
{%- endfor -%}
{%- endfor %}

// Property definition arrays
{%- for interface in interfaces -%}
extern const JSCFunctionListEntry js_{{ interface.name|lower }}_defs[];
{%- endfor %}

// Interface object class definition (not user classes)
{%- for interface in interfaces -%}
extern const JSClassDef js_{{ interface.name|lower }}_class_def;
{%- endfor %}

// RIDL user classes
{%- for class in classes -%}
// Numeric class id is provided by mqjs_ridl_class_id.h (generated by mquickjs build tool).
#define RIDL_CLASS_ID_{{ class.name|upper }} RIDL_CLASS_{{ module_name }}_{{ class.name }}

void js_{{ module_name|lower }}_{{ class.name|lower }}_class(void);
{%- endfor %}

{{ class_defs }}

// Module initialization functions
{%- for interface in interfaces -%}
int js_{{ interface.name|lower }}_init(JSContext *ctx, JSModuleDef *m);
{%- endfor %}

// Singletons
{%- for s in singletons %}
{%- for method in s.methods %}
JSValue js_{{ s.name|lower }}_{{ method.name|lower }}(JSContext *ctx, JSValue *this_val, int argc, JSValue *argv);
{%- endfor %}
{%- for prop in s.properties %}
{%- if prop.modifiers|is_readonly_prop %}
JSValue js_{{ s.name|lower }}_get_{{ prop.name|lower }}(JSContext *ctx, JSValue *this_val, int argc, JSValue *argv);
{%- endif %}
{%- endfor %}
{%- endfor %}

// Extension definitions
//
// NOTE: For global singletons (e.g. `console`), registration requires file-scope
// declarations/definitions (props/object defs) *and* global table entries.
// A single macro expanded only inside `js_global_object[]` is insufficient.

// File-scope declarations/definitions for RIDL extensions
#define JS_RIDL_DECLS \
{%- for s in singletons %}
    static const JSPropDef js_{{ s.name|lower }}_props[] = { \
{%- for method in s.methods %}
        JS_CFUNC_DEF("{{ method.name }}", {{ method.params|length }}, js_{{ s.name|lower }}_{{ method.name|lower }}), \
{%- endfor %}
{%- for prop in s.properties %}
{%- if prop.modifiers|is_readonly_prop %}
        JS_CGETSET_DEF("{{ prop.name }}", js_{{ s.name|lower }}_get_{{ prop.name|lower }}, NULL), \
{%- endif %}
{%- endfor %}
        JS_PROP_END, \
    }; \
    static const JSClassDef js_{{ s.name|lower }}_obj = \
        JS_OBJECT_DEF("{{ s.name|capitalize }}", js_{{ s.name|lower }}_props); \
{%- endfor %}
    /* empty */

/* Ensure `JS_RIDL_DECLS` can be used as a statement in C code. */
#define JS_RIDL_DECLS_STMT do { } while (0)

// Entries injected into `js_global_object[]`
#define JS_STDLIB_EXTENSIONS_{{ module_name|upper }} \
{%- for function in functions %}
    JS_CFUNC_DEF("{{ function.name }}", {{ function.params|length }}, js_{{ function.name|lower }}), \
{%- endfor %}
{%- for interface in interfaces -%}
{%- for method in interface.methods %}
    JS_CFUNC_DEF("{{ method.name }}", {{ method.params|length }}, js_{{ interface.name|lower }}_{{ method.name|lower }}), \
{%- endfor -%}
{%- endfor %}
/* singletons are registered as global object properties (e.g. globalThis.console) */ \
{%- for s in singletons %}
    JS_PROP_CLASS_DEF("{{ s.name }}", &js_{{ s.name|lower }}_obj), \
{%- endfor %}

#define JS_RIDL_GLOBAL_PROPS \
    JS_STDLIB_EXTENSIONS_{{ module_name|upper }}

// Backward-compat hook (to be migrated out of templates)
#define JS_RIDL_EXTENSIONS \
    JS_RIDL_GLOBAL_PROPS

#endif // MJS_RIDL_REGISTER_H